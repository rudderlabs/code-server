name: Update Cline Version

on:
  repository_dispatch:
    types: [cline-release]
  workflow_dispatch:
    inputs:
      version:
        description: "Cline version (e.g., 4.0.0)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-cline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            TAG="${{ github.event.client_payload.tag }}"
          else
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${{ github.event.inputs.version }}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "branch=update-cline-${VERSION}" >> $GITHUB_OUTPUT

      - name: Get current version
        id: current
        run: |
          if [ -f .cline-version ]; then
            CURRENT=$(cat .cline-version)
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
          else
            echo "version=none" >> $GITHUB_OUTPUT
          fi

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" = "${{ steps.vars.outputs.version }}" ]; then
            echo "Update not needed. Current version: ${{ steps.current.outputs.version }}"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "Update needed. Current: ${{ steps.current.outputs.version }}, New: ${{ steps.vars.outputs.version }}"
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify VSIX exists in release
        if: steps.check.outputs.needed == 'true'
        run: |
          DOWNLOAD_URL="https://github.com/rudderlabs/cline/releases/download/${{ steps.vars.outputs.tag }}/cline-${{ steps.vars.outputs.version }}.vsix"
          echo "Checking if VSIX exists at: $DOWNLOAD_URL"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$DOWNLOAD_URL")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: VSIX not found at $DOWNLOAD_URL (HTTP $HTTP_CODE)"
            exit 1
          fi

          echo "âœ… VSIX verified at $DOWNLOAD_URL"

      - name: Update .cline-version file
        if: steps.check.outputs.needed == 'true'
        run: |
          echo "${{ steps.vars.outputs.version }}" > .cline-version
          cat .cline-version

      - name: Create Pull Request
        if: steps.check.outputs.needed == 'true'
        uses: peter-evans/create-pull-request@4e1beaa7521e8b457b572c090b25bd3db56bf1c5 # v5.0.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Cline to ${{ steps.vars.outputs.version }}"
          branch: ${{ steps.vars.outputs.branch }}
          delete-branch: true
          title: "chore: update Cline to ${{ steps.vars.outputs.version }}"
          body: |
            ## Summary
            This PR updates the Cline extension to version **${{ steps.vars.outputs.version }}**.

            ## Changes
            - Updated `.cline-version` to `${{ steps.vars.outputs.version }}`
            - VSIX will be downloaded automatically during Docker build workflow

            ## Release Notes
            See: https://github.com/rudderlabs/cline/releases/tag/${{ steps.vars.outputs.tag }}

            ## Testing
            To test this change, trigger the `build-docker` workflow with this branch.
            The workflow will:
            1. Read version from `.cline-version`
            2. Download the VSIX from Cline releases
            3. Build Docker image with the new version

            ## Checklist
            - [ ] Verify Docker build succeeds
            - [ ] Verify Cline extension loads correctly in container

            ---
            ðŸ¤– This PR was automatically generated by the Cline release workflow.
          labels: |
            automated
            cline-update
            dependencies
